---
title: "Project 1"
author: "Cassandra"
date: "2/17/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(rwunderground)
library(geosphere)
library(lubridate)
library(chron)
library(ggplot2)
library(ggthemes)
library(gridExtra)

bikesample <- read.csv("Sample_Citibike_Data.csv")
```

#Question 1

Explore the dataset to calculate descriptive statistics. Do exploratory visualization to better understand the dataset.

```{r}


```


#Question 2

Identify patterns in the ride history data. Explain/illustrate these patterns using appropriate visualization.

Some ride history patterns we looked at have to do with the age of CitiBike users. 
```{r}
bikesample$age <- 2016-bikesample$birth.year
summary(bikesample$age)

#separating ages into different groups, specified in comments above
age1 <- subset(bikesample, age <= 20) #1190 observations
age2 <- subset(bikesample, age >= 21 & age <= 30) #26185 observations
age3 <- subset(bikesample, age >= 31 & age <= 40) #28984 observations
age4 <- subset(bikesample, age >= 41 & age <= 50) #17732 observations
age5 <- subset(bikesample, age >= 51 & age <= 60) #11626 observations
age6 <- subset(bikesample, age >= 61 & age <= 70) #3539 observations
age7 <- subset(bikesample, age >= 71 & age <= 80) #466 observations
age8 <- subset(bikesample, age >= 81) #48 observations, some of these ages are reaaaaally large though, max age is 131

ageTeens <- age1
ageYoungAdults <- age2
ageAdults <- merge(age3, age4, all = TRUE)
ageAdults <- merge(ageAdults, age5, all = TRUE)
ageSeniors <- merge(age6, age7, all = TRUE)
ageSeniors <- merge(ageSeniors, age8, all = TRUE)

boxplot(ageTeens$tripduration, ageYoungAdults$tripduration, ageAdults$tripduration, ageSeniors$tripduration, main = "Trip Duration", ylab = "Trip Duration (Seconds)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline=FALSE) 
summary(ageAdults$tripduration)
summary(ageYoungAdults$tripduration)
```

These boxplots show that the median trip duration in seconds was the lowest for teenagers (bikers less than or equal to 20 years old) and the highest for seniors (bikers at least 61 years old). This prompted the question of why seniors took so much more time biking than younger people, so we compared biking distances and speeds for the four groups as well.

```{r}
ageTeens$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), ageTeens$start.station.longitude, ageTeens$start.station.latitude, ageTeens$end.station.longitude, ageTeens$end.station.latitude) #to find distances of all bike trips 

ageYoungAdults$distance <- ageYoungAdults$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), ageYoungAdults$start.station.longitude, ageYoungAdults$start.station.latitude, ageYoungAdults$end.station.longitude, ageYoungAdults$end.station.latitude) #to find distances of all bike trips 

ageAdults$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), ageAdults$start.station.longitude, ageAdults$start.station.latitude, ageAdults$end.station.longitude, ageAdults$end.station.latitude)

ageSeniors$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), ageSeniors$start.station.longitude, ageSeniors$start.station.latitude, ageSeniors$end.station.longitude, ageSeniors$end.station.latitude)

boxplot(ageTeens$distance, ageYoungAdults$distance, ageAdults$distance, ageSeniors$distance,  main = "Trip Distance", ylab = "Trip Distance (Meters)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline = FALSE) 
``` 

While analyzing the data provided for distance, we noticed that some distances were showing up as 0, even though the time duration was positive. This means that the start location and end location were the same, and it wasn't possible to gauge the distance that the biker had actually traveled. 

Regardless, these boxplots show that, despite the trip distance in meters was the lowest for teenagers (which makes sense as they have the lowest trip duration as well). However, although seniors had the highest trip duration, they have the second lowest trip distance. Thus, we came to the conclusion that we should look at speed as well. 

```{r}
#getting average speed of the trip by doing sped = distance (meters) / time (second)
ageTeens$speed <- ageTeens$distance / ageTeens$tripduration #unit is meters per second
ageYoungAdults$speed <- ageYoungAdults$distance / ageYoungAdults$tripduration
ageAdults$speed <- ageAdults$distance / ageAdults$tripduration
ageSeniors$speed <- ageSeniors$distance / ageSeniors$tripduration

boxplot(ageTeens$speed, ageYoungAdults$speed, ageAdults$speed, ageSeniors$speed,  main = "Trip Speed", ylab = "Speed (meters / second)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline = FALSE) 

summary(ageTeens$speed)
summary(ageYoungAdults$speed)
summary(ageAdults$speed)
summary(ageSeniors$speed)
```

To get speed, we used the speed formula (speed = distance / time). Here, we can see that senior bikers were indeed biking at lower speeds than their younger counterparts. Compared to young adults, who were on average biking the fastest out of all the age groups, seniors were biking approximately 0.376 m/s slower. Additionally, we now see that young adults are biking at the fastest average speed, which explains why even though they have the highest trip distance, they don't have the highest trip duration.

Delving deeper into the data extracted above, we wanted to visually see the distances that bikers traveled separated by age, as well as the speeds that bikers traveled at separated by age, both of which can be seen in the plots below:

```{r}
bikesample$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), bikesample$start.station.longitude, bikesample$start.station.latitude, bikesample$end.station.longitude, bikesample$end.station.latitude)

bikesample$speed <- bikesample$distance / bikesample$tripduration

bikesample$ageID <- ifelse(bikesample$age <= 20, 1, ifelse(bikesample$age >= 21 & bikesample$age <= 30, 2, ifelse(bikesample$age >= 31 & bikesample$age <= 60, 3, 4)))

#plot1 shows the distances that people travel visually separated by age. 
plot1 <- ggplot() + geom_jitter(aes(y = bikesample$distance, x = bikesample$age, colour = bikesample$ageID), data = bikesample, stat="identity")
plot1

#plot2 shows the speeds that people travel visually separated by age. You can see that seniors (people over 61) are clearly traveling at lower speeds than young professionals (people between 21 and 30).
plot2 <- ggplot() + geom_jitter(aes(y = bikesample$speed, x = bikesample$age, colour = bikesample$ageID), data = bikesample, stat="identity")
plot2

model1 = lm(bikesample$distance ~ bikesample$speed)
plot(x = bikesample$speed, y = bikesample$distance)
abline(model1)
summary(model1)

```

Next, we wanted to look at if there were some times where more people of the same age group (ex. teenagers) came out to bike compared to other times of the day. 

```{r}
#Show the amount of teenagers per each time... how to do?? line graph? NEEDS TO BE COMPLETED

ageTeens$starttime <- as.POSIXlt(ageTeens$starttime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)
ageTeens$stoptime <- as.POSIXlt(ageTeens$stoptime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)

ageTeens$month <- month(ageTeens$starttime) #helps with seasons
ageTeens$hour <- hour(ageTeens$starttime) #helps with time of day
ageTeens$hour <- ifelse((minute(ageTeens$starttime) >= 16 & minute(ageTeens$starttime) <= 30), ageTeens$hour+0.25, ageTeens$hour)
ageTeens$hour <- ifelse((minute(ageTeens$starttime) >= 31 & minute(ageTeens$starttime) <= 45), ageTeens$hour+0.5, ageTeens$hour)
ageTeens$hour <- ifelse((minute(ageTeens$starttime) >= 46 & minute(ageTeens$starttime) <= 60), ageTeens$hour+0.75, ageTeens$hour)

numTeensHours <- seq(from = 0, to = 23.75, by = 0.25)
numTeensHoursAt <- numeric(length(numTeensHours))
for(i in 1:length(numTeensHours)) {
  numTeensHoursAt[i] = length(which(ageTeens$hour == numTeensHours[i])) 
}

numTeensHours$numHours <- as.data.frame(numTeensHours)
numTeensHoursAt <- as.data.frame(numTeensHoursAt)
teens <- cbind(numTeensHours, numTeensHoursAt)

teensPlot <- ggplot(data = teens, aes(x=numTeensHours, y=numTeensHoursAt)) + geom_line() + geom_smooth()
cat("This is a line graph showing how many teens (under 20) were riding citibikes at each quarter hour of the day.")

ageYoungAdults$starttime <- as.POSIXlt(ageYoungAdults$starttime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)
ageYoungAdults$stoptime <- as.POSIXlt(ageYoungAdults$stoptime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)

ageYoungAdults$month <- month(ageYoungAdults$starttime) #helps with seasons
ageYoungAdults$hour <- hour(ageYoungAdults$starttime) #helps with time of day
ageYoungAdults$hour <- ifelse((minute(ageYoungAdults$starttime) >= 16 & minute(ageYoungAdults$starttime) <= 30), ageYoungAdults$hour+0.25, ageYoungAdults$hour)
ageYoungAdults$hour <- ifelse((minute(ageYoungAdults$starttime) >= 31 & minute(ageYoungAdults$starttime) <= 45), ageYoungAdults$hour+0.5, ageYoungAdults$hour)
ageYoungAdults$hour <- ifelse((minute(ageYoungAdults$starttime) >= 46 & minute(ageYoungAdults$starttime) <= 60), ageYoungAdults$hour+0.75, ageYoungAdults$hour)

numYoungAdultsHours <- seq(from = 0, to = 23.75, by = 0.25)
numYoungAdultsHoursAt <- numeric(length(numYoungAdultsHours))
for(i in 1:length(numYoungAdultsHours)) {
  numYoungAdultsHoursAt[i] = length(which(ageYoungAdults$hour == numYoungAdultsHours[i])) 
}

numYoungAdultsHours$numHours <- as.data.frame(numYoungAdultsHours)
numYoungAdultsHoursAt <- as.data.frame(numYoungAdultsHoursAt)
youngAdults <- cbind(numYoungAdultsHours, numYoungAdultsHoursAt)

youngAdultsPlot <- ggplot(data = youngAdults, aes(x=numYoungAdultsHours, y=numYoungAdultsHoursAt)) + geom_line() + geom_smooth()
cat("This is a line graph showing how many young adults were riding citibikes at each half hour of the day.")

ageAdults$starttime <- as.POSIXlt(ageAdults$starttime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)
ageAdults$stoptime <- as.POSIXlt(ageAdults$stoptime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)

ageAdults$month <- month(ageAdults$starttime) #helps with seasons
ageAdults$hour <- hour(ageAdults$starttime) #helps with time of day
ageAdults$hour <- ifelse((minute(ageAdults$starttime) >= 16 & minute(ageAdults$starttime) <= 30), ageAdults$hour+0.25, ageAdults$hour)
ageAdults$hour <- ifelse((minute(ageAdults$starttime) >= 31 & minute(ageAdults$starttime) <= 45), ageAdults$hour+0.5, ageAdults$hour)
ageAdults$hour <- ifelse((minute(ageAdults$starttime) >= 46 & minute(ageAdults$starttime) <= 60), ageAdults$hour+0.75, ageAdults$hour)

numAdultHours <- seq(from = 0, to = 23.75, by = 0.25)
numAdultHoursAt <- numeric(length(numAdultHours))
for(i in 1:length(numAdultHours)) {
  numAdultHoursAt[i] = length(which(ageAdults$hour == numAdultHours[i])) 
}

numAdultHours$numHours <- as.data.frame(numAdultHours)
numAdultHoursAt <- as.data.frame(numAdultHoursAt)
adults <- cbind(numAdultHours, numAdultHoursAt)

adultsPlot <- ggplot(data = adults, aes(x=numAdultHours, y=numAdultHoursAt)) + geom_line() + geom_smooth()
cat("This is a line graph showing how many adults were riding citibikes at each half hour of the day.")

ageSeniors$starttime <- as.POSIXlt(ageSeniors$starttime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)
ageSeniors$stoptime <- as.POSIXlt(ageSeniors$stoptime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)

ageSeniors$month <- month(ageSeniors$starttime) #helps with seasons
ageSeniors$hour <- hour(ageSeniors$starttime) #helps with time of day
ageSeniors$hour <- ifelse((minute(ageSeniors$starttime) >= 16 & minute(ageSeniors$starttime) <= 30), ageSeniors$hour+0.25, ageSeniors$hour)
ageSeniors$hour <- ifelse((minute(ageSeniors$starttime) >= 31 & minute(ageSeniors$starttime) <= 45), ageSeniors$hour+0.5, ageSeniors$hour)
ageSeniors$hour <- ifelse((minute(ageSeniors$starttime) >= 46 & minute(ageSeniors$starttime) <= 60), ageSeniors$hour+0.75, ageSeniors$hour)

numSeniorHours <- seq(from = 0, to = 23.75, by = 0.25)
numSeniorHoursAt <- numeric(length(numSeniorHours))
for(i in 1:length(numSeniorHours)) {
  numSeniorHoursAt[i] = length(which(ageSeniors$hour == numSeniorHours[i])) 
}

numSeniorHours$numHours <- as.data.frame(numSeniorHours)
numSeniorHoursAt <- as.data.frame(numSeniorHoursAt)
seniors <- cbind(numSeniorHours, numSeniorHoursAt)

seniorsPlot <- ggplot(data = seniors, aes(x=numSeniorHours, y=numSeniorHoursAt)) + geom_line() + geom_smooth()
cat("This is a line graph showing how many seniors were riding citibikes at each half hour of the day.")

##try to find a way to combine them??
grid.arrange(teensPlot, youngAdultsPlot, adultsPlot, seniorsPlot)
```

```{r}
#gender and speed FOR NATASHA'S PART
genderM <- subset(bikesample, gender == 1)
genderF <- subset(bikesample, gender == 2)

genderM$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), genderM$start.station.longitude, genderM$start.station.latitude, genderM$end.station.longitude, genderM$end.station.latitude) 

genderF$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), genderF$start.station.longitude, genderF$start.station.latitude, genderF$end.station.longitude, genderF$end.station.latitude) 

genderM$speed <- genderM$distance / genderM$tripduration
genderF$speed <- genderF$distance / genderF$tripduration

boxplot(genderM$speed, genderF$speed,  main = "Trip Speed by Gender", ylab = "Speed (meters / second)", names = c("Male", "Female"), outline = FALSE) 

summary(genderM$speed)
summary(genderF$speed)

#other possible questions:
#seasons affect which age groups use citibike the most? NATASHA'S CODE HAS SEASONS - CAN USE THAT
#show what times are most popular for teens, young professionals, adults, and seniors to ride (respectively)

```

```{r}
#standard deviation - NATASHA
subscribers <- subset(bikesample, usertype == "Subscriber")

subsAvgDuration <- mean(subscribers$tripduration, na.rm=TRUE)
subsAvgDurationMin <- subsAvgDuration / 60

subsDurationSD <- sd(subscribers$tripduration, na.rm = TRUE)
subsDurationSDMin <- subsDurationSD / 60

subsAvgDurationMin
subsDurationSDMin


sd(subsAvgDurationMin)

plot(x=subscribers$tripduration, outline=FALSE)

plot(x=subscribers$tripduration, ylim=c(0,1e+04))
```

#Question 3

Assymetric Traffic: Stations running out of bikes because of assymetric traffic (arrivals and departures are not equal) is a big problem. Client would want to know which stations are candidates for increasing bike storage capacity. Client would like to see these stations on a map based visualization.
```{r}
#Extract the numbers of leaves and arrivals from the data set 
start_station <- as.data.frame(table(bikesample$start.station.name))
end_station <- as.data.frame(table(bikesample$end.station.name))

#Extract the location of stations from the data set and omit the repeaded lines
names_coor <- data.frame(bikesample$start.station.name, bikesample$start.station.latitude, bikesample$start.station.longitude) 
deduped.names_coor <- unique(names_coor)

#Combine the data frames together and calculate the out-bike ratio
stations <- merge(start_station,end_station,by.x="Var1",by.y="Var1")
stations_coor <- merge(stations,deduped.names_coor,by.x="Var1",by.y="bikesample.start.station.name")
stations_coor$out_bike_ratio =stations_coor[,3]/stations_coor[,2]-1

#Import the related libraries
if(!require('ggmap')){
  install.packages('ggmap', repos = "http://cran.us.r-project.org")
  library(ggmap)
}

if(!require('ggplot2')){
  install.packages('ggplot2', repos = "http://cran.us.r-project.org")
  library(ggplot2)
}

#select the stations to plot
stations_coor_selected <- stations_coor[stations_coor$out_bike_ratio>0.2,]

#plot the google map in R
map <- get_googlemap(center = c(lon = -73.97, lat = 40.73), zoom = 12,size = c(640, 640))

#plot the selected bike stations onto the google map and displace the points' color according to the degree that the staion is running out of bikes
ggmap(map)+geom_point(data = stations_coor_selected, aes(x = bikesample.start.station.longitude, y = bikesample.start.station.latitude,fill = out_bike_ratio), size = 2, shape = 21,show.legend = TRUE) + scale_fill_gradient(low = "#0000FF", high = "#FF0000")

#Print the names
print(stations_coor_selected[,1])
```


#Question 4

Impact of Weather. Client wants to know the impact of weather (temperature, rain, snow, wind) on the CitiBike system. 
```{r}
#linear regression, tempearture as y, behavior as x
```